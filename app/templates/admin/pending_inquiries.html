{% extends "base.html" %}

{% block title %}Pending Inquiries - Bot Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-exclamation-triangle text-warning"></i> Pending Inquiries</h2>
                <div>
                    <a href="{{ url_for('admin_bot.manage_responses') }}" class="btn btn-outline-primary me-2">
                        <i class="fas fa-robot"></i> Bot Responses
                    </a>
                    <a href="{{ url_for('admin_bot.analytics') }}" class="btn btn-outline-info">
                        <i class="fas fa-chart-line"></i> Analytics
                    </a>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Pending</h6>
                                    <h4>{{ inquiries.total }}</h4>
                                </div>
                                <i class="fas fa-clock fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Needs Human Review</h6>
                                    <h4>{{ inquiries.items|selectattr('requires_human_attention')|list|length }}</h4>
                                </div>
                                <i class="fas fa-user-tie fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Unprocessed by Bot</h6>
                                    <h4>{{ inquiries.items|rejectattr('bot_processed')|list|length }}</h4>
                                </div>
                                <i class="fas fa-robot fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-secondary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Current Page</h6>
                                    <h4>{{ inquiries.page }} / {{ inquiries.pages }}</h4>
                                </div>
                                <i class="fas fa-list fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions -->
            {% if inquiries.items %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-tasks"></i> Bulk Actions</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin_bot.bulk_process_inquiries') }}" id="bulkForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="row align-items-end">
                            <div class="col-md-6">
                                <label class="form-label">Selected Inquiries:</label>
                                <p class="text-muted small mb-2">Use checkboxes below to select inquiries for bulk processing.</p>
                            </div>
                            <div class="col-md-6 text-end">
                                <button type="button" id="selectAll" class="btn btn-outline-secondary btn-sm me-2">Select All</button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-robot"></i> Process Selected with Bot
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}

            <!-- Inquiries List -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> Inquiries Requiring Attention</h5>
                </div>
                <div class="card-body">
                    {% if inquiries.items %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th width="50">
                                            <input type="checkbox" id="masterCheck" class="form-check-input">
                                        </th>
                                        <th>Inquiry</th>
                                        <th>Status</th>
                                        <th>Bot Processing</th>
                                        <th>Sentiment</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for inquiry in inquiries.items %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="inquiry_ids" value="{{ inquiry.id }}" 
                                                   class="form-check-input inquiry-checkbox" form="bulkForm">
                                        </td>
                                        <td>
                                            <div>
                                                <strong>{{ inquiry.name }}</strong>
                                                <small class="text-muted d-block">{{ inquiry.email }}</small>
                                                <div class="mt-1">
                                                    <span class="badge bg-primary">{{ inquiry.subject }}</span>
                                                </div>
                                                <div class="mt-2">
                                                    <small class="text-muted">{{ inquiry.message[:100] }}{% if inquiry.message|length > 100 %}...{% endif %}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if inquiry.status == 'new' %}
                                                <span class="badge bg-warning">New</span>
                                            {% elif inquiry.status == 'bot_responded' %}
                                                <span class="badge bg-info">Bot Responded</span>
                                            {% elif inquiry.status == 'needs_review' %}
                                                <span class="badge bg-danger">Needs Review</span>
                                            {% elif inquiry.status == 'in_progress' %}
                                                <span class="badge bg-primary">In Progress</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ inquiry.status.title() }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if inquiry.bot_processed %}
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-check-circle text-success me-2"></i>
                                                    <div>
                                                        <small class="text-success">Processed</small>
                                                        {% if inquiry.last_bot_response_at %}
                                                            <br><small class="text-muted">{{ inquiry.last_bot_response_at.strftime('%m/%d %H:%M') }}</small>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% if inquiry.requires_human_attention %}
                                                    <div class="mt-1">
                                                        <span class="badge bg-warning">Escalated</span>
                                                    </div>
                                                {% endif %}
                                            {% else %}
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-clock text-warning me-2"></i>
                                                    <small class="text-warning">Pending</small>
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if inquiry.sentiment %}
                                                {% if inquiry.sentiment == 'positive' %}
                                                    <i class="fas fa-smile text-success" title="Positive"></i>
                                                {% elif inquiry.sentiment == 'negative' %}
                                                    <i class="fas fa-frown text-danger" title="Negative"></i>
                                                {% else %}
                                                    <i class="fas fa-meh text-secondary" title="Neutral"></i>
                                                {% endif %}
                                                <small class="ms-1">{{ inquiry.sentiment.title() }}</small>
                                            {% else %}
                                                <small class="text-muted">Unknown</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small>{{ inquiry.created_at.strftime('%m/%d/%Y') }}</small>
                                            <br><small class="text-muted">{{ inquiry.created_at.strftime('%H:%M') }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                {% if not inquiry.bot_processed %}
                                                    <form method="POST" action="{{ url_for('admin_bot.process_inquiry_with_bot', inquiry_id=inquiry.id) }}" class="d-inline">
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                        <button type="submit" class="btn btn-outline-primary" title="Process with Bot">
                                                            <i class="fas fa-robot"></i>
                                                        </button>
                                                    </form>
                                                {% else %}
                                                    <form method="POST" action="{{ url_for('admin_bot.reprocess_inquiry', inquiry_id=inquiry.id) }}" class="d-inline">
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                        <button type="submit" class="btn btn-outline-warning" title="Reprocess with Bot">
                                                            <i class="fas fa-redo"></i>
                                                        </button>
                                                    </form>
                                                {% endif %}
                                                <a href="{{ url_for('admin_inquiry.inquiry_detail', id=inquiry.id) }}" class="btn btn-outline-info" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        {% if inquiries.pages > 1 %}
                        <nav aria-label="Inquiries pagination" class="mt-4">
                            <ul class="pagination justify-content-center">
                                {% if inquiries.has_prev %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('admin_bot.pending_inquiries', page=inquiries.prev_num) }}">Previous</a>
                                    </li>
                                {% endif %}
                                
                                {% for page_num in inquiries.iter_pages() %}
                                    {% if page_num %}
                                        {% if page_num != inquiries.page %}
                                            <li class="page-item">
                                                <a class="page-link" href="{{ url_for('admin_bot.pending_inquiries', page=page_num) }}">{{ page_num }}</a>
                                            </li>
                                        {% else %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ page_num }}</span>
                                            </li>
                                        {% endif %}
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if inquiries.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('admin_bot.pending_inquiries', page=inquiries.next_num) }}">Next</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                            <h4>All Caught Up!</h4>
                            <p class="text-muted">No inquiries require attention at this time.</p>
                            <a href="{{ url_for('admin_bot.manage_responses') }}" class="btn btn-primary">
                                <i class="fas fa-robot"></i> Manage Bot Responses
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Checkbox handling
document.getElementById('masterCheck').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.inquiry-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
});

document.getElementById('selectAll').addEventListener('click', function() {
    const checkboxes = document.querySelectorAll('.inquiry-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = !allChecked;
    });
    
    document.getElementById('masterCheck').checked = !allChecked;
    this.textContent = allChecked ? 'Select All' : 'Deselect All';
});

// Update master checkbox when individual checkboxes change
document.querySelectorAll('.inquiry-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.inquiry-checkbox');
        const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
        const masterCheck = document.getElementById('masterCheck');
        
        masterCheck.checked = checkedCount === checkboxes.length;
        masterCheck.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
    });
});

// Form submission confirmation
document.getElementById('bulkForm').addEventListener('submit', function(e) {
    const checkedBoxes = document.querySelectorAll('.inquiry-checkbox:checked');
    if (checkedBoxes.length === 0) {
        e.preventDefault();
        alert('Please select at least one inquiry to process.');
        return;
    }
    
    if (!confirm(`Process ${checkedBoxes.length} inquiries with the bot system?`)) {
        e.preventDefault();
    }
});
</script>
{% endblock %}
