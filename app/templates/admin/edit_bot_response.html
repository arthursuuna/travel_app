{% extends "base.html" %}

{% block title %}Edit Bot Response - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-edit text-primary"></i> Edit Bot Response</h2>
                <div>
                    <a href="{{ url_for('admin_bot.manage_responses') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Responses
                    </a>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-robot"></i> Response Configuration</h5>
                            <div>
                                <span class="badge bg-{{ 'success' if response.is_active else 'secondary' }}">
                                    {{ 'Active' if response.is_active else 'Inactive' }}
                                </span>
                                <span class="badge bg-info ms-1">{{ response.category.title() }}</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <form method="POST" id="botResponseForm">
                                {{ form.hidden_tag() }}
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="category" class="form-label">Category *</label>
                                        {{ form.category(class="form-select") }}
                                        {% if form.category.errors %}
                                            <div class="text-danger small">
                                                {% for error in form.category.errors %}
                                                    <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="confidence_threshold" class="form-label">
                                            Confidence Threshold *
                                            <span class="text-muted">(<span id="confidenceValue">{{ (response.confidence_threshold * 100)|round|int }}</span>%)</span>
                                        </label>
                                        {{ form.confidence_threshold(class="form-range", min="0.1", max="1.0", step="0.05", 
                                                                   value=response.confidence_threshold, 
                                                                   oninput="updateConfidenceDisplay(this.value)") }}
                                        <div class="d-flex justify-content-between small text-muted">
                                            <span>Low (10%)</span>
                                            <span>Medium (50%)</span>
                                            <span>High (90%)</span>
                                        </div>
                                        {% if form.confidence_threshold.errors %}
                                            <div class="text-danger small">
                                                {% for error in form.confidence_threshold.errors %}
                                                    <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="trigger_keywords" class="form-label">
                                        Trigger Keywords *
                                        <small class="text-muted">(comma-separated)</small>
                                    </label>
                                    {{ form.trigger_keywords(class="form-control", value=response.trigger_keywords) }}
                                    <div class="form-text">
                                        Enter keywords that should trigger this response. Use comma to separate multiple keywords.
                                    </div>
                                    {% if form.trigger_keywords.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.trigger_keywords.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="response_text" class="form-label">Response Template *</label>
                                    {{ form.response_text(class="form-control", rows="8", value=response.response_text) }}
                                    <div class="form-text">
                                        This is the message that will be sent to users. You can use placeholders like {name} if needed.
                                    </div>
                                    {% if form.response_text.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.response_text.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-4">
                                    <div class="form-check">
                                        {{ form.is_active(class="form-check-input", checked=response.is_active) }}
                                        <label class="form-check-label" for="is_active">
                                            Active Response
                                        </label>
                                        <div class="form-text">
                                            Only active responses will be used by the bot to respond to inquiries.
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <div>
                                        <button type="button" class="btn btn-info me-2" onclick="testResponse()">
                                            <i class="fas fa-flask"></i> Test Response
                                        </button>
                                        <button type="button" class="btn btn-warning" onclick="duplicateResponse()">
                                            <i class="fas fa-copy"></i> Duplicate
                                        </button>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-danger me-2" onclick="deleteResponse()">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-save"></i> Save Changes
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <!-- Usage Statistics -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6><i class="fas fa-chart-bar"></i> Usage Statistics</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="border-end">
                                        <h4 class="text-primary">{{ usage_stats.total_uses }}</h4>
                                        <small class="text-muted">Total Uses</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <h4 class="text-success">{{ "%.1f"|format(usage_stats.success_rate) }}%</h4>
                                    <small class="text-muted">Success Rate</small>
                                </div>
                            </div>
                            <hr>
                            <div class="small">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Last 7 days:</span>
                                    <span class="fw-bold">{{ usage_stats.last_7_days }}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Last 30 days:</span>
                                    <span class="fw-bold">{{ usage_stats.last_30_days }}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Last used:</span>
                                    <span class="fw-bold">
                                        {% if usage_stats.last_used %}
                                            {{ usage_stats.last_used.strftime('%Y-%m-%d') }}
                                        {% else %}
                                            Never
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Response Preview -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6><i class="fas fa-eye"></i> Response Preview</h6>
                        </div>
                        <div class="card-body">
                            <div id="responsePreview" class="border p-3 bg-light rounded min-height-150">
                                <div class="border-start border-primary border-3 ps-3">
                                    <small class="text-muted d-block mb-1">
                                        <i class="fas fa-robot"></i> Bot Response ({{ response.category }})
                                    </small>
                                    <div style="white-space: pre-wrap;">{{ response.response_text }}</div>
                                </div>
                                <small class="text-muted mt-2 d-block">
                                    <strong>Triggers:</strong> {{ response.trigger_keywords }}
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Interactions -->
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-history"></i> Recent Uses</h6>
                        </div>
                        <div class="card-body">
                            {% if recent_uses %}
                                {% for use in recent_uses %}
                                <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                                    <div>
                                        <div class="small fw-bold">{{ use.inquiry.name }}</div>
                                        <div class="small text-muted">{{ use.inquiry.subject[:30] }}...</div>
                                        <div class="small text-success">
                                            <i class="fas fa-check"></i> {{ "%.0f"|format(use.confidence * 100) }}% match
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="small text-muted">{{ use.timestamp.strftime('%m/%d') }}</div>
                                        <button class="btn btn-outline-primary btn-sm" disabled>
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center text-muted">
                                    <i class="fas fa-inbox fa-2x mb-2"></i>
                                    <p>No recent uses</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Modal -->
<div class="modal fade" id="testModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Bot Response</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="testMessage" class="form-label">Test Message:</label>
                    <textarea class="form-control" id="testMessage" rows="3" 
                              placeholder="Enter a test message to see if this response would be triggered..."></textarea>
                </div>
                <div id="testResults" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="runTest()">
                    <i class="fas fa-play"></i> Run Test
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this bot response?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    This action cannot be undone. The response has been used <strong>{{ usage_stats.total_uses }}</strong> time{{ 's' if usage_stats.total_uses != 1 else '' }}.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('admin_bot.delete_response', response_id=response.id) }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete Response
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Update confidence display
function updateConfidenceDisplay(value) {
    document.getElementById('confidenceValue').textContent = Math.round(value * 100);
    updatePreview();
}

// Update preview when form changes
document.addEventListener('DOMContentLoaded', function() {
    const responseText = document.getElementById('response_text');
    const triggerKeywords = document.getElementById('trigger_keywords');
    const category = document.getElementById('category');
    
    responseText.addEventListener('input', updatePreview);
    triggerKeywords.addEventListener('input', updatePreview);
    category.addEventListener('change', updatePreview);
});

function updatePreview() {
    const responseText = document.getElementById('response_text').value;
    const category = document.getElementById('category').value;
    const keywords = document.getElementById('trigger_keywords').value;
    const preview = document.getElementById('responsePreview');
    
    if (responseText.trim()) {
        preview.innerHTML = `
            <div class="border-start border-primary border-3 ps-3">
                <small class="text-muted d-block mb-1">
                    <i class="fas fa-robot"></i> Bot Response (${category})
                </small>
                <div style="white-space: pre-wrap;">${responseText}</div>
            </div>
            ${keywords ? `<small class="text-muted mt-2 d-block"><strong>Triggers:</strong> ${keywords}</small>` : ''}
        `;
    }
}

function testResponse() {
    const modal = new bootstrap.Modal(document.getElementById('testModal'));
    modal.show();
}

function runTest() {
    const testMessage = document.getElementById('testMessage').value;
    const responseText = document.getElementById('response_text').value;
    const keywords = document.getElementById('trigger_keywords').value;
    const category = document.getElementById('category').value;
    const confidence = document.getElementById('confidence_threshold').value;
    
    if (!testMessage.trim()) {
        alert('Please enter a test message');
        return;
    }
    
    const resultsDiv = document.getElementById('testResults');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Testing...</div>';
    
    // Call the actual test endpoint
    fetch('/admin/bot/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            text: testMessage,
            response_id: {{ response.id }}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayTestResults(data);
        } else {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
        }
    })
    .catch(error => {
        resultsDiv.innerHTML = '<div class="alert alert-danger">Network error occurred</div>';
    });
}

function displayTestResults(data) {
    const resultsDiv = document.getElementById('testResults');
    const analysis = data.analysis;
    const response = data.response;
    
    let html = `
        <div class="alert alert-${response ? 'success' : 'warning'}">
            <h6><i class="fas fa-${response ? 'check' : 'exclamation-triangle'}"></i> Test Results</h6>
            <p><strong>Would trigger this response:</strong> ${response ? 'Yes' : 'No'}</p>
            <p><strong>Calculated confidence:</strong> ${(analysis.confidence * 100).toFixed(1)}%</p>
            <p><strong>Category match:</strong> ${analysis.category}</p>
        </div>
    `;
    
    if (response) {
        html += `
            <div class="mt-3">
                <h6>Generated Response:</h6>
                <div class="border p-3 bg-light rounded">
                    <pre style="white-space: pre-wrap; font-family: inherit;">${response.text}</pre>
                </div>
            </div>
        `;
    }
    
    resultsDiv.innerHTML = html;
}

function duplicateResponse() {
    if (confirm('Create a copy of this response for editing?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("admin_bot.duplicate_response", response_id=response.id) }}';
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = '{{ csrf_token() }}';
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

function deleteResponse() {
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

// Form submission handling
document.getElementById('botResponseForm').addEventListener('submit', function(e) {
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    submitBtn.disabled = true;
    
    // Reset button state after a delay (in case of validation errors)
    setTimeout(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }, 3000);
});
</script>

<style>
.min-height-150 {
    min-height: 150px;
}
</style>
{% endblock %}
