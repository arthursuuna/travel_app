{% extends "base.html" %}

{% block title %}Create Bot Response - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-plus text-primary"></i> Create Bot Response</h2>
                <div>
                    <a href="{{ url_for('admin_bot.manage_responses') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Responses
                    </a>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-robot"></i> Response Configuration</h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" id="botResponseForm">
                                {{ form.hidden_tag() }}
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="category" class="form-label">Category *</label>
                                        {{ form.category(class="form-select") }}
                                        {% if form.category.errors %}
                                            <div class="text-danger small">
                                                {% for error in form.category.errors %}
                                                    <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="confidence_threshold" class="form-label">
                                            Confidence Threshold *
                                            <span class="text-muted">(<span id="confidenceValue">70</span>%)</span>
                                        </label>
                                        {{ form.confidence_threshold(class="form-range", min="0.1", max="1.0", step="0.05", value="0.7", oninput="updateConfidenceDisplay(this.value)") }}
                                        <div class="d-flex justify-content-between small text-muted">
                                            <span>Low (10%)</span>
                                            <span>Medium (50%)</span>
                                            <span>High (90%)</span>
                                        </div>
                                        {% if form.confidence_threshold.errors %}
                                            <div class="text-danger small">
                                                {% for error in form.confidence_threshold.errors %}
                                                    <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="trigger_keywords" class="form-label">
                                        Trigger Keywords *
                                        <small class="text-muted">(comma-separated)</small>
                                    </label>
                                    {{ form.trigger_keywords(class="form-control", placeholder="e.g., book, booking, reservation, reserve, schedule") }}
                                    <div class="form-text">
                                        Enter keywords that should trigger this response. Use comma to separate multiple keywords.
                                        The bot will match these keywords in user messages.
                                    </div>
                                    {% if form.trigger_keywords.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.trigger_keywords.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="response_text" class="form-label">Response Template *</label>
                                    {{ form.response_text(class="form-control", rows="8", placeholder="Enter the response template that the bot will send...") }}
                                    <div class="form-text">
                                        This is the message that will be sent to users. You can use placeholders like {name} if needed.
                                    </div>
                                    {% if form.response_text.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.response_text.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-4">
                                    <div class="form-check">
                                        {{ form.is_active(class="form-check-input") }}
                                        <label class="form-check-label" for="is_active">
                                            Active Response
                                        </label>
                                        <div class="form-text">
                                            Only active responses will be used by the bot to respond to inquiries.
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-info" onclick="testResponse()">
                                        <i class="fas fa-flask"></i> Test Response
                                    </button>
                                    <div>
                                        <button type="button" class="btn btn-secondary me-2" onclick="resetForm()">
                                            <i class="fas fa-undo"></i> Reset
                                        </button>
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-save"></i> Create Response
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <!-- Preview Panel -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6><i class="fas fa-eye"></i> Response Preview</h6>
                        </div>
                        <div class="card-body">
                            <div id="responsePreview" class="border p-3 bg-light rounded min-height-150">
                                <em class="text-muted">Response preview will appear here...</em>
                            </div>
                        </div>
                    </div>

                    <!-- Category Guidelines -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6><i class="fas fa-info-circle"></i> Category Guidelines</h6>
                        </div>
                        <div class="card-body">
                            <div id="categoryGuidelines">
                                <em class="text-muted">Select a category to see guidelines...</em>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Responses -->
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-list"></i> Existing Responses</h6>
                        </div>
                        <div class="card-body">
                            <div id="existingResponses">
                                {% for category, count in existing_responses.items() %}
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="badge bg-{{ 'primary' if category == 'general' else 'info' }}">{{ category.title() }}</span>
                                    <small class="text-muted">{{ count }} response{{ 's' if count != 1 else '' }}</small>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Modal -->
<div class="modal fade" id="testModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Bot Response</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="testMessage" class="form-label">Test Message:</label>
                    <textarea class="form-control" id="testMessage" rows="3" 
                              placeholder="Enter a test message to see if this response would be triggered..."></textarea>
                </div>
                <div id="testResults" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="runTest()">
                    <i class="fas fa-play"></i> Run Test
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const categoryGuidelines = {
    'general': {
        description: 'General inquiries about the company, services overview, or basic information.',
        keywords: 'company, about, info, help, services, general',
        tone: 'Friendly and informative'
    },
    'booking': {
        description: 'Booking-related inquiries including reservations, availability, and scheduling.',
        keywords: 'book, booking, reserve, reservation, schedule, availability',
        tone: 'Helpful and process-oriented'
    },
    'pricing': {
        description: 'Questions about costs, prices, packages, and payment information.',
        keywords: 'price, cost, package, payment, fee, rate, discount',
        tone: 'Clear and transparent'
    },
    'cancellation': {
        description: 'Cancellation policies, refunds, and modification requests.',
        keywords: 'cancel, refund, modify, change, policy, terms',
        tone: 'Empathetic and clear'
    },
    'location': {
        description: 'Questions about destinations, pickup points, and travel locations.',
        keywords: 'location, destination, pickup, address, where, place',
        tone: 'Descriptive and helpful'
    },
    'duration': {
        description: 'Inquiries about trip duration, timing, and schedules.',
        keywords: 'duration, time, schedule, hours, days, when',
        tone: 'Precise and informative'
    },
    'requirements': {
        description: 'Travel requirements, documents, preparation, and what to bring.',
        keywords: 'requirements, documents, bring, prepare, need, visa',
        tone: 'Detailed and advisory'
    }
};

// Update confidence display
function updateConfidenceDisplay(value) {
    document.getElementById('confidenceValue').textContent = Math.round(value * 100);
}

// Update preview and guidelines when form changes
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('botResponseForm');
    const category = document.getElementById('category');
    const responseText = document.getElementById('response_text');
    const triggerKeywords = document.getElementById('trigger_keywords');
    
    // Update preview when response text changes
    responseText.addEventListener('input', updatePreview);
    
    // Update guidelines when category changes
    category.addEventListener('change', function() {
        updateGuidelines(this.value);
        updatePreview();
    });
    
    // Update preview when keywords change
    triggerKeywords.addEventListener('input', updatePreview);
    
    // Initial update
    updateGuidelines(category.value);
    updatePreview();
});

function updatePreview() {
    const responseText = document.getElementById('response_text').value;
    const category = document.getElementById('category').value;
    const keywords = document.getElementById('trigger_keywords').value;
    const preview = document.getElementById('responsePreview');
    
    if (responseText.trim()) {
        preview.innerHTML = `
            <div class="border-start border-primary border-3 ps-3">
                <small class="text-muted d-block mb-1">
                    <i class="fas fa-robot"></i> Bot Response (${category})
                </small>
                <div style="white-space: pre-wrap;">${responseText}</div>
            </div>
            ${keywords ? `<small class="text-muted mt-2 d-block"><strong>Triggers:</strong> ${keywords}</small>` : ''}
        `;
    } else {
        preview.innerHTML = '<em class="text-muted">Response preview will appear here...</em>';
    }
}

function updateGuidelines(category) {
    const guidelines = document.getElementById('categoryGuidelines');
    const guide = categoryGuidelines[category];
    
    if (guide) {
        guidelines.innerHTML = `
            <div class="mb-3">
                <strong class="text-primary">${category.charAt(0).toUpperCase() + category.slice(1)}</strong>
                <p class="small mb-2">${guide.description}</p>
                <div class="small">
                    <strong>Suggested Keywords:</strong><br>
                    <span class="text-muted">${guide.keywords}</span>
                </div>
                <div class="small mt-2">
                    <strong>Tone:</strong> <span class="text-muted">${guide.tone}</span>
                </div>
            </div>
        `;
    } else {
        guidelines.innerHTML = '<em class="text-muted">Select a category to see guidelines...</em>';
    }
}

function testResponse() {
    const modal = new bootstrap.Modal(document.getElementById('testModal'));
    modal.show();
}

function runTest() {
    const testMessage = document.getElementById('testMessage').value;
    const responseText = document.getElementById('response_text').value;
    const keywords = document.getElementById('trigger_keywords').value;
    const category = document.getElementById('category').value;
    const confidence = document.getElementById('confidence_threshold').value;
    
    if (!testMessage.trim()) {
        alert('Please enter a test message');
        return;
    }
    
    const resultsDiv = document.getElementById('testResults');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Testing...</div>';
    
    // Simulate test (in real implementation, this would call the backend)
    setTimeout(() => {
        const keywordList = keywords.toLowerCase().split(',').map(k => k.trim());
        const messageWords = testMessage.toLowerCase().split(' ');
        const matches = keywordList.filter(keyword => 
            messageWords.some(word => word.includes(keyword) || keyword.includes(word))
        );
        
        const matchConfidence = matches.length > 0 ? Math.min(0.9, matches.length * 0.3 + 0.4) : 0.1;
        const wouldTrigger = matchConfidence >= parseFloat(confidence);
        
        resultsDiv.innerHTML = `
            <div class="alert alert-${wouldTrigger ? 'success' : 'warning'}">
                <h6><i class="fas fa-${wouldTrigger ? 'check' : 'exclamation-triangle'}"></i> Test Results</h6>
                <p><strong>Would trigger this response:</strong> ${wouldTrigger ? 'Yes' : 'No'}</p>
                <p><strong>Calculated confidence:</strong> ${Math.round(matchConfidence * 100)}%</p>
                <p><strong>Required confidence:</strong> ${Math.round(parseFloat(confidence) * 100)}%</p>
                ${matches.length > 0 ? `<p><strong>Matched keywords:</strong> ${matches.join(', ')}</p>` : '<p><strong>No keywords matched</strong></p>'}
            </div>
            ${wouldTrigger && responseText ? `
                <div class="mt-3">
                    <h6>Generated Response:</h6>
                    <div class="border p-3 bg-light rounded">
                        <pre style="white-space: pre-wrap; font-family: inherit;">${responseText}</pre>
                    </div>
                </div>
            ` : ''}
        `;
    }, 1000);
}

function resetForm() {
    if (confirm('Are you sure you want to reset the form? All changes will be lost.')) {
        document.getElementById('botResponseForm').reset();
        updatePreview();
        updateGuidelines(document.getElementById('category').value);
        updateConfidenceDisplay(0.7);
    }
}

// Form submission handling
document.getElementById('botResponseForm').addEventListener('submit', function(e) {
    const responseText = document.getElementById('response_text').value;
    const keywords = document.getElementById('trigger_keywords').value;
    
    if (!responseText.trim() || !keywords.trim()) {
        e.preventDefault();
        alert('Please fill in all required fields');
        return;
    }
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    submitBtn.disabled = true;
    
    // Reset button state after a delay (in case of validation errors)
    setTimeout(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }, 3000);
});
</script>

<style>
.min-height-150 {
    min-height: 150px;
}
</style>
{% endblock %}
