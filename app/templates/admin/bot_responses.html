{% extends "base.html" %}

{% block title %}Bot Response Management - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-robot text-primary"></i> Bot Response Management</h2>
                <div>
                    <a href="{{ url_for('admin_bot.analytics') }}" class="btn btn-info me-2">
                        <i class="fas fa-chart-line"></i> Analytics
                    </a>
                    <a href="{{ url_for('admin_bot.create_response') }}" class="btn btn-success">
                        <i class="fas fa-plus"></i> New Response
                    </a>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Responses</h6>
                                    <h4>{{ responses|length }}</h4>
                                </div>
                                <i class="fas fa-comments fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Active Responses</h6>
                                    <h4>{{ responses|selectattr('is_active')|list|length }}</h4>
                                </div>
                                <i class="fas fa-check-circle fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Categories</h6>
                                    <h4>{{ responses|map(attribute='category')|unique|list|length }}</h4>
                                </div>
                                <i class="fas fa-tags fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Avg Confidence</h6>
                                    <h4>{{ "%.1f"|format((responses|sum(attribute='confidence_threshold')/responses|length)*100) if responses else 0 }}%</h4>
                                </div>
                                <i class="fas fa-brain fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Bot Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-flask"></i> Test Bot Response</h5>
                </div>
                <div class="card-body">
                    <form id="testBotForm">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="testSubject" class="form-label">Subject:</label>
                                <input type="text" class="form-control" id="testSubject" placeholder="Test inquiry subject">
                            </div>
                            <div class="col-md-6">
                                <label for="testText" class="form-label">Message:</label>
                                <textarea class="form-control" id="testText" rows="3" placeholder="Enter test message..."></textarea>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">
                            <i class="fas fa-play"></i> Test Bot
                        </button>
                    </form>
                    <div id="testResults" class="mt-3" style="display: none;"></div>
                </div>
            </div>

            <!-- Responses Table -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> Bot Response Templates</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Keywords</th>
                                    <th>Confidence</th>
                                    <th>Status</th>
                                    <th>Usage</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for response in responses %}
                                <tr>
                                    <td>
                                        <span class="badge bg-{{ 'primary' if response.category == 'general' else ('success' if response.category in ['booking', 'pricing'] else 'info') }}">
                                            {{ response.category.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="text-muted small">{{ response.trigger_keywords[:50] }}{% if response.trigger_keywords|length > 50 %}...{% endif %}</span>
                                    </td>
                                    <td>{{ (response.confidence_threshold * 100)|round(1) }}%</td>
                                    <td>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input toggle-response" type="checkbox" 
                                                   data-response-id="{{ response.id }}" 
                                                   {{ 'checked' if response.is_active }}>
                                            <label class="form-check-label">
                                                {{ 'Active' if response.is_active else 'Inactive' }}
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ response_stats.get(response.id, 0) }} uses</span>
                                    </td>
                                    <td>{{ response.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('admin_bot.edit_response', response_id=response.id) }}" 
                                               class="btn btn-outline-primary" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button class="btn btn-outline-info" 
                                                    onclick="viewResponse({{ response.id }})" title="View">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Response View Modal -->
<div class="modal fade" id="responseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bot Response Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="responseModalBody">
                <!-- Content loaded via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Toggle response active status
document.querySelectorAll('.toggle-response').forEach(toggle => {
    toggle.addEventListener('change', function() {
        const responseId = this.dataset.responseId;
        const isActive = this.checked;
        
        fetch(`/admin/bot/response/${responseId}/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const label = this.nextElementSibling;
                label.textContent = data.is_active ? 'Active' : 'Inactive';
                
                // Show success message
                showAlert('success', data.message);
            } else {
                // Revert toggle on error
                this.checked = !isActive;
                showAlert('error', 'Failed to update response status');
            }
        })
        .catch(error => {
            // Revert toggle on error
            this.checked = !isActive;
            showAlert('error', 'Network error occurred');
        });
    });
});

// Test bot functionality
document.getElementById('testBotForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const subject = document.getElementById('testSubject').value.trim();
    const text = document.getElementById('testText').value.trim();
    const resultsDiv = document.getElementById('testResults');
    
    if (!text) {
        showAlert('warning', 'Please enter a test message');
        return;
    }
    
    // Show loading
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Testing bot...</div>';
    
    // Get CSRF token if available
    const csrfToken = document.querySelector('meta[name=csrf-token]');
    const headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
    };
    
    if (csrfToken) {
        headers['X-CSRFToken'] = csrfToken.getAttribute('content');
    }
    
    const requestData = {
        text: text,
        subject: subject || 'Test Subject'
    };
    
    console.log('Sending request:', requestData);
    
    fetch('/admin/bot/test', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(requestData),
        credentials: 'same-origin'
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`HTTP ${response.status}: ${response.statusText} - ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            displayTestResults(data);
        } else {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Unknown error'}</div>`;
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        resultsDiv.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
    });
});

function displayTestResults(data) {
    const resultsDiv = document.getElementById('testResults');
    const analysis = data.analysis;
    const response = data.response;
    const escalation = data.escalation;
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h6>Analysis Results:</h6>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Category:</span>
                        <span class="badge bg-primary">${analysis.category}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Confidence:</span>
                        <span class="badge bg-${analysis.confidence > 0.7 ? 'success' : 'warning'}">${(analysis.confidence * 100).toFixed(1)}%</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Sentiment:</span>
                        <span class="badge bg-${analysis.sentiment === 'positive' ? 'success' : (analysis.sentiment === 'negative' ? 'danger' : 'secondary')}">${analysis.sentiment}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Urgent:</span>
                        <span class="badge bg-${analysis.is_urgent ? 'danger' : 'success'}">${analysis.is_urgent ? 'Yes' : 'No'}</span>
                    </li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>Response & Escalation:</h6>
    `;
    
    if (response) {
        html += `
                <div class="alert alert-success">
                    <strong>Bot Response Generated:</strong><br>
                    <small class="text-muted">Confidence: ${(response.confidence * 100).toFixed(1)}%</small>
                </div>
        `;
    } else {
        html += '<div class="alert alert-warning">No bot response generated</div>';
    }
    
    if (escalation.should_escalate) {
        html += `
                <div class="alert alert-danger">
                    <strong>Will Escalate to Human:</strong><br>
                    <small>${escalation.reasons.join(', ')}</small>
                </div>
        `;
    } else {
        html += '<div class="alert alert-success">No escalation needed</div>';
    }
    
    html += '</div></div>';
    
    if (response) {
        html += `
            <div class="mt-3">
                <h6>Generated Response:</h6>
                <div class="border p-3 bg-light rounded">
                    <pre style="white-space: pre-wrap; font-family: inherit;">${response.text}</pre>
                </div>
            </div>
        `;
    }
    
    resultsDiv.innerHTML = html;
}

function viewResponse(responseId) {
    // Find the response data from the serialized data
    const responses = {{ responses_data|tojson }};
    const response = responses.find(r => r.id === responseId);
    
    if (response) {
        const modalBody = document.getElementById('responseModalBody');
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Response Details:</h6>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Category:</strong> ${response.category}</li>
                        <li class="list-group-item"><strong>Confidence Threshold:</strong> ${(response.confidence_threshold * 100).toFixed(1)}%</li>
                        <li class="list-group-item"><strong>Status:</strong> ${response.is_active ? 'Active' : 'Inactive'}</li>
                        <li class="list-group-item"><strong>Created:</strong> ${new Date(response.created_at).toLocaleString()}</li>
                        <li class="list-group-item"><strong>Updated:</strong> ${new Date(response.updated_at).toLocaleString()}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>Keywords:</h6>
                    <div class="border p-2 bg-light rounded mb-3">
                        <small>${response.trigger_keywords}</small>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <h6>Response Template:</h6>
                <div class="border p-3 bg-light rounded">
                    <pre style="white-space: pre-wrap; font-family: inherit;">${response.response_text}</pre>
                </div>
            </div>
        `;
        
        new bootstrap.Modal(document.getElementById('responseModal')).show();
    }
}

function showAlert(type, message) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}
</script>
{% endblock %}
